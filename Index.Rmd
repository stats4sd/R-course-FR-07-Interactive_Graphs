---
title: "Graphiques interactifs avec plotly et leaflet"
output: 
  learnr::tutorial:
  progressive: true
allow_skip: true
df_print: paged
runtime: shiny_prerendered
description: >
  Learn to impress your friends with interactive graphs
---

```{r setup,include=FALSE}
library(leaflet)
library(dplyr)
library(plotly)
library(ggplot2)
library(learnr)


beaven.barley <- read.csv("beanven_barley.csv")


experiment2017<-read.csv("experiment2017.csv")

```
  
  
## Vue d'ensemble

Dans cette session, nous allons vous montrer comment il est facile de faire des graphiques interactifs en utilisant R. 

Tout d'abord, nous allons vous montrer comment transformer n'importe quel graphique de `ggplot2` en un graphique interactif, que vous pouvez intégrer dans un site web ou une présentation en utilisant le package `plotly`.

Comme ceci :

```{r introp,echo=FALSE,message=FALSE}
( beaven.barley%>%
  ggplot(aes(x=col, y=gen, colour=yield, row=row))+
    geom_point(size=3)+
      scale_color_distiller(palette="Spectral")+
        labs(title="Genotype by Column, coloured by yield") ) %>%
          ggplotly()

```



Ensuite, nous vous montrerons comment faire des cartes interactives en utilisant le package `leaflet`. 

Comme ceci :

```{r intromap,echo=FALSE,message=FALSE}
leaflet(experiment2017) %>%
  addCircleMarkers(~Longitude, ~Latitude,popup = ~Farmer) %>%
    addProviderTiles('Esri.DeLorme') %>%
      addControl("Location of farms from 2017 experiment",position="topright")
```

Avant de commencer, nous devons nous assurer que nous installons et chargeons les packages nécessaires à ce module. Nous avons besoin du package `plotly` pour réaliser notre premier graphique interactif et du package `leaflet` pour réaliser notre carte. Nous allons également utiliser un jeu de données du package `agridat`. Enfin, comme d'habitude maintenant, nous utiliserons aussi les packages `ggplot2` et `dplyr`. Vous devriez déjà les avoir installés, mais ils doivent aussi être chargés.


```
library(leaflet)
library(plotly)
library(agridat)
library(ggplot2)
library(dplyr)

```



## Graphiques Interactifs avec plotly

Imaginons que nous travaillons avec le jeu de données `beaven.barley` que nous avons utilisé lors de l'exercice sur la modélisation. Pour montrer la relation entre les génotypes et le rendement, tout en tenant compte du fort impact de l'emplacement en colonne de nos parcelles, nous décidons de faire un nuage de points en plaçant les différents génotypes (`gen`) sur l'axe des y, l'emplacement des parcelles en colonne de notre plan expérimental (`col`) sur l'axe des x, et nous colorons les points en fonction du rendement (`yield`). Nous avons besoin d'une palette divergente forte pour la couleur basée sur le rendement et, après quelques tentatives, nous avons trouvé différentes [palettes de couleurs](https://ggplot2.tidyverse.org/reference/scale_brewer.html), La palette `Spectral` avec la fonction scale_color_distiller() semble bien marcher, donc nous decidons de l'utiliser.

Voila notre graphique:

```{r plot1,exercise=TRUE}

beaven.barley%>%
  ggplot(aes(x=col, y=gen, colour=yield))+
    geom_point(size=3)+
      scale_color_distiller(palette="Spectral")+
        labs(title="Genotype by Column, coloured by yield")

```


Ce graphique est intéressant. Nous voyons clairement l'effet de la structure en colonnes de notre experience et nous semblons également voir quelques différences de rendement entre les génotypes.

Peut-être nous pourrion impressionner nos amis, collègues et superviseurs en utilisant ce graphique dans une présentation. Mais nous pourrions les impressionner encore plus en le transformant en un graphique interactif, en seulement deux étapes simples:

* Stocker le graphique en tant qu'objet 
* Utilisez la fonction `ggplotly()` sur cet objet. 

```{r plot2,exercise=TRUE}

p1 <- beaven.barley %>%
  ggplot(aes(x=col, y=gen, colour=yield))+
    geom_point(size=3)+
      scale_color_distiller(palette="Spectral")+
        labs(title="Genotype by Column, coloured by yield")

ggplotly(p1)

```


C'est tout ! Bien sûr, n'oubliez pas d'installer et de charger d'abord le package `plotly`. 


La chose essentielle à noter est que le `+` ne peut pas vous amener à ce point. Vous devez stocker le graphique en tant qu'objet et ensuite exécuter la fonction sur cet objet. 
Vous pouvez aussi mettre toute la commande qui engendre le graphique entre parenthèses et utiliser l'operateur pipe vers la fonction `ggplotly()`:


```{r plot3, exercise=TRUE}

( beaven.barley%>%
    ggplot(aes(x=col, y=gen, colour=yield))+
      geom_point(size=3)+
        scale_color_distiller(palette="Spectral")+
          labs(title="Genotype by Column, coloured by yield") ) %>%
            ggplotly()


```

Remarquez que si vous passez la souris sur l'un des points, une fenêtre contextuelle s'affiche avec les valeurs des données sous-jacentes.

Une autre fonctionnalité intéressante que vous pouvez utiliser ici est d'ajouter des esthétiques supplémentaires qui n'apparaîtront que dans la fenêtre contextuelle. Par exemple, nous pouvons ajouter les informations de la structure `row`:

```{r plot4,exercise=TRUE}
( beaven.barley%>%
  ggplot(aes(x=col, y=gen, colour=yield, row=row))+
    geom_point(size=3)+
      scale_color_distiller(palette="Spectral")+
        labs(title="Genotype by Column, coloured by yield") ) %>%
          ggplotly()

```

La plupart, mais pas toutes les choses que vous pouvez personnaliser dans `ggplot2` apparaîtront dans le graphe interactif mais parfois vous rencontrerez certaines géométries ou caractéristiques personnalisées qui ne seront pas interactives. Dans ce cas, vous obtiendrez de nombreux messages d'avertissement, mais aussi un graphique auquel il peut manquer certaines caractéristiques. 

Mais, en général, cette étape supplémentaire fonctionne bien comme un moyen très simple d'animer un graphique pour une présentation. Faites-en l'expérience avec vos propres graphiques !

Il existe également des options supplémentaires pour personnaliser les fonctions interactives du graphique. Vous pouvez en savoir plus sur ces options <a href="https://plotly-r.com/improving-ggplotly.html" target="_blank">ici  </a>  



## Cartes interactives avec leaflet

Lorsque nous réalisons des expériences dans des fermes, il est parfois utile de collecter les coordonnées géographiques des fermes et de les placer sur une carte, pour voir si le paysage géographique peut expliquer certains des résultats que nous observons. 

Ainsi, à titre d'exemple, nous allons placer les fermes fictives des données experiment2017 sur une carte en utilisant les informations de latitude et de longitude qui sont inclus dans les données. Voici un rappel de l'aspect des données :
```{r,echo=FALSE}
DT::datatable(experiment2017)

```

Je pourrais placer les coordonnées en utilisant `ggplot2`. Mais cela nous donnerait un graphique pas tres interessant sans le contexte qu'une carte fournirait.

Cependant, le package `leaflet` permet de produire facilement des cartes simples et interactives.
Le nombre de fonctions, et d'options possibles dans `leaflet` peut faire peut. On peut vraiment faire beaucoup de chose ! Mais il est très simple de faire une belle carte avec seulement quelques fonctions simples, et en s'en tenant aux options par défaut.

Pour commencer, vous devez indiquer les données a utiliser dans `leaflet()`. Cela ressemble beaucoup à l'étape initiale `ggplot(data=)` où nous chargeons les données, en vue des étapes d'apres.
Mais en soi, cette étape fournit juste une un cadre blanc.

```{r map0, exercise=TRUE}

leaflet(experiment2017)

```

Comme vous pouvez le voir, il ne se passe pas grand-chose !

Mais nous pouvons maintenant penser à afficher les données. Dans notre cas, nous avons des données agricoles que nous voulons inclure. Un bon moyen de placer des points sur une carte est d'ajouter des cercles avec la fonction `addCircleMarkers()`.

Une différence très importante avec `ggplot2`, est que pour ajouter des couches dans `leaflet`, nous utilisons l'operateur pipe `%>%` et non le `+`.

Dans la fonction `addCircleMarkers()`, nous devons identifier les colonnes de coordonnées de nos données. D'abord la longitude, puis la latitude, les deux noms de colonnes étant précédés d'un tilde `~`. Et pour que les étapes ultérieures de cette carte soient produites correctement, ces coordonnées doivent être au format degrés décimaux. 

Le code ressemble donc à ceci :


```{r map1, exercise=TRUE}
leaflet(experiment2017) %>%
  addCircleMarkers(~Longitude, ~Latitude)
```

Un peu plus utile ! Nous pouvons maintenant voir la position de nos fermes les unes par rapport aux autres. Mais c'est ce que nous aurions pu faire avec `ggplot`. Maintenant, ce que nous voulons vraiment, c'est les voir superposées sur une carte. Nous pouvons le faire en utilisant la fonction `addTiles()`.

```{r map2, exercise=TRUE}
leaflet(experiment2017) %>%
  addCircleMarkers(~Longitude, ~Latitude) %>%
    addTiles()
```

Comme vous pouvez le voir, on option une carte par défaut assez jolie. Cette carte est la carte basique de Open Street Map. 
Nous avons produit une carte fonctionnelle et interactive en quelques lignes seulement. 
En plus de l'apparence par défaut d'Open Street Map, `leaflet` permet d'intégrer facilement des couches cartes provenant de toutes sortes de sources tierces. Celles-ci sont disponibles via la fonction `addProviderTiles()`, au lieu de la fonction `addTiles()`. 

Ici, nous appelons une couche carte différente ('Esri.DeLorme'), qui met un peu plus en valeur les différentes caractéristiques présentes dans la zone de nos fermes :

```{r map3,exercise=TRUE}
leaflet(experiment2017) %>%
  addCircleMarkers(~Longitude, ~Latitude) %>%
    addProviderTiles('Esri.DeLorme')
```

Vous pouvez voir toutes les couches disponibles que vous pouvez utiliser. <a href="http://leaflet-extras.github.io/leaflet-providers/preview/" target="_blank">here  </a>  

Le menu déroulant sur le côté droit de la page montre un aperçu de ces carte. Le nom court que vous pouvez voir dans ce menu peut etre mis dans `addProviderTiles()` pour permettre l'utilisation de la carte correspondante dans `leaflet`.

Certaines de ces couches de carte ne sont pas open source, et nécessitent donc un enregistrement et une authentification pour pouvoir y accéder, mais il y en a beaucoup qui peuvent être utilisées librement à condition qu'elles soient référencées de manière appropriée. Vous verrez que les références sont automatiquement incorporées dans les graphiques, donc vous n'avez même pas besoin de penser à cette étape !


Il pourrait également être utile de fournir un peu plus d'informations sur la carte.
Pour l'instant, si je clique sur un de mes points, rien ne se passe. Mais dans `addCircleMarkers()`, je peux demander a R de faire apparaitre une fenêtre qui affiche le contenu d'une des colonnes de mes données lorsque je clique dessus. Similaire à ce que nous avons vu avec `plotly`.
Je vais donc ajouter la colonne "Farmer", pour associer le nom de l'agriculteur à aux cercles de la carte. La aussi nous avons besoin d'un tilde `~` devant le nom de la colonne lorsque. C'est comme ca que `leaflet` marche.

```{r mapagain,exercise=TRUE}
leaflet(experiment2017) %>%
  addCircleMarkers(~Longitude, ~Latitude,popup = ~Farmer) %>%
    addProviderTiles('Esri.DeLorme')
```

Si vous cliquez sur un cercle bleu, vous devriez maintenant voir le nom de l'agriculteur pour chaque ferme.

Un autre ajout utile pourrait être de mettre un titre sur cette carte. La fonction pour cela n'a pas vraiment un nom intuitif : `addControl()`.

```{r anothermap,exercise=TRUE}
leaflet(experiment2017) %>%
  addCircleMarkers(~Longitude, ~Latitude,popup = ~Farmer) %>%
    addProviderTiles('Esri.DeLorme') %>%
      addControl("Location of farms from 2017 experiment")
```

Par défaut, il apparaît en haut à gauche, sous les commandes de zoom. Je ne suis pas sûr de l'aimer là, donc je vais plutôt le déplacer en haut à droite.

```{r finalmap,exercise=TRUE}
leaflet(experiment2017) %>%
  addCircleMarkers(~Longitude, ~Latitude,popup = ~Farmer) %>%
    addProviderTiles('Esri.DeLorme') %>%
      addControl("Location of farms from 2017 experiment",position="topright")
```

Et je pense que je suis maintenant satisfait de ma carte ! 

Mais je n'ai même pas commencé à effleurer la surface de ce que leaflet peut faire. Vous pouvez trouver un tutoriel beaucoup plus complet pour leaflet ici, qui couvrira toutes sortes d'autres façons de présenter des cartes et d'incorporer vos propres données dans ces cartes :
<a href="https://rstudio.github.io/leaflet/" target="_blank">https://rstudio.github.io/leaflet/  </a>  

Il est intéressant de noter que `leaflet` est un peu différent de beaucoup d'autres packages R, puisqu'il s'agit d'un package JavaScript qui a été traduit en R. Et lorsque vous recherchez `leaflet` en ligne, vous rencontrerez généralement des personnes qui parlent de la façon d'écrire du code JavaScript plutôt que du code R. Veillez donc à inclure "R" dans tous les termes de recherche lorsque vous cherchez de l'aide.

